{% extends "base.html" %}

{% block title %}Workflows - Workflow Visualization{% endblock %}

{% block content %}
<div class="row">
    <!-- Page Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-project-diagram me-2"></i>Interactive Workflow Visualization</h1>
            <div>
                <button class="btn btn-outline-primary me-2" onclick="refreshWorkflows()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button class="btn btn-primary" onclick="showWorkflowInfo()">
                    <i class="fas fa-info-circle me-1"></i>Info
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Workflow List -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-list me-1"></i>Available Workflows
                </h6>
            </div>
            <div class="card-body">
                <div id="workflows-container">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>
                        <p>Loading workflows...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Interactive Workflow Diagram -->
<div class="row mt-4" id="workflow-diagram-container" style="display: none;">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-sitemap me-1"></i>Workflow Execution Diagram
                </h6>
                <div>
                    <button class="btn btn-sm btn-success me-2" onclick="executeWorkflow('play')">
                        <i class="fas fa-play me-1"></i>Play
                    </button>
                    <button class="btn btn-sm btn-warning me-2" onclick="executeWorkflow('pause')">
                        <i class="fas fa-pause me-1"></i>Pause
                    </button>
                    <button class="btn btn-sm btn-danger me-2" onclick="executeWorkflow('stop')">
                        <i class="fas fa-stop me-1"></i>Stop
                    </button>
                    <button class="btn btn-sm btn-info" onclick="executeWorkflow('step')">
                        <i class="fas fa-forward me-1"></i>Step
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="workflow-stages" class="workflow-stages-container">
                    <!-- Workflow stages will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Workflow Details Panel -->
<div class="row mt-4" id="workflow-details-container" style="display: none;">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-info-circle me-1"></i>Workflow Details
                </h6>
            </div>
            <div class="card-body">
                <div id="workflow-details">
                    <!-- Workflow details will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Execution Progress -->
<div class="row mt-4" id="execution-progress-container" style="display: none;">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-tasks me-1"></i>Execution Progress
                </h6>
            </div>
            <div class="card-body">
                <div class="progress mb-3" style="height: 25px;">
                    <div id="execution-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%">0%</div>
                </div>
                <div id="execution-status" class="text-muted">
                    Ready to execute...
                </div>
            </div>
        </div>
    </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Global variables for Phase 2
let currentWorkflowId = null;
let workflowStages = [];
let executionInterval = null;

// Load available workflows
function loadWorkflows() {
    fetch('/api/workflows')
        .then(response => response.json())
        .then(data => {
            displayWorkflows(data.workflows);
        })
        .catch(error => {
            console.error('Error loading workflows:', error);
            showNotification('Failed to load workflows', 'danger');
        });
}

// Display workflows in the container
function displayWorkflows(workflows) {
    const container = document.getElementById('workflows-container');
    
    if (!workflows || workflows.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-3x text-gray-300 mb-3"></i>
                <h5 class="text-gray-500">No Workflows Found</h5>
                <p class="text-gray-400">No workflow data is currently available.</p>
                <button class="btn btn-primary" onclick="loadWorkflows()">
                    <i class="fas fa-sync-alt me-1"></i>Check Again
                </button>
            </div>
        `;
        return;
    }
    
    const workflowsHtml = workflows.map(workflow => `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100 workflow-card" onclick="selectWorkflow('${workflow.id}')">
                <div class="card-body text-center">
                    <div class="workflow-icon mb-3">
                        <i class="fas fa-project-diagram fa-3x text-primary"></i>
                    </div>
                    <h6 class="card-title">${workflow.type}</h6>
                    <p class="card-text small">ID: ${workflow.id.substring(0, 8)}...</p>
                    <div class="workflow-status mb-2">
                        ${getStatusBadge(workflow.status)}
                    </div>
                    <div class="workflow-stage small text-muted">
                        Stage: ${workflow.stage || 'Unknown'}
                    </div>
                    <div class="workflow-actions mt-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewWorkflowDetails('${workflow.id}')">
                            <i class="fas fa-eye me-1"></i>View
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); loadWorkflowStages('${workflow.id}')">
                            <i class="fas fa-sitemap me-1"></i>Diagram
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = `
        <div class="row">
            ${workflowsHtml}
        </div>
    `;
}

// Select a workflow for visualization
function selectWorkflow(workflowId) {
    currentWorkflowId = workflowId;
    loadWorkflowStages(workflowId);
    showNotification(`Selected workflow: ${workflowId.substring(0, 8)}...`, 'info');
}

// Load workflow stages for visualization
function loadWorkflowStages(workflowId) {
    console.log('üîó Diagram button clicked for workflow:', workflowId);
    
    if (!socket) {
        console.error('‚ùå Socket not available for loadWorkflowStages');
        showNotification('WebSocket not connected', 'warning');
        return;
    }
    
    if (!socket.connected) {
        console.error('‚ùå Socket not connected for loadWorkflowStages');
        showNotification('WebSocket connection lost', 'warning');
        return;
    }
    
    console.log('üì° Emitting get_workflow_stages event for workflow:', workflowId);
    socket.emit('get_workflow_stages', { workflow_id: workflowId });
}

// View workflow details
function viewWorkflowDetails(workflowId) {
    console.log('üëÅÔ∏è View button clicked for workflow:', workflowId);
    
    if (!socket) {
        console.error('‚ùå Socket not available for viewWorkflowDetails');
        showNotification('WebSocket not connected', 'warning');
        return;
    }
    
    if (!socket.connected) {
        console.error('‚ùå Socket not connected for viewWorkflowDetails');
        showNotification('WebSocket connection lost', 'warning');
        return;
    }
    
    console.log('üì° Emitting get_workflow_details event for workflow:', workflowId);
    socket.emit('get_workflow_details', { workflow_id: workflowId });
}

// Execute workflow commands
function executeWorkflow(action) {
    if (!currentWorkflowId) {
        showNotification('Please select a workflow first', 'warning');
        return;
    }
    
    if (!socket) {
        showNotification('WebSocket not connected', 'warning');
        return;
    }
    
    socket.emit('execute_workflow', { 
        workflow_id: currentWorkflowId, 
        action: action 
    });
    
    showNotification(`Workflow ${action} command sent`, 'info');
    
    // Show execution progress
    document.getElementById('execution-progress-container').style.display = 'block';
    
    // Simulate progress for demo
    if (action === 'play') {
        simulateExecutionProgress();
    }
}

// Simulate execution progress
function simulateExecutionProgress() {
    const progressBar = document.getElementById('execution-progress-bar');
    const status = document.getElementById('execution-status');
    let progress = 0;
    
    if (executionInterval) {
        clearInterval(executionInterval);
    }
    
    executionInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress >= 100) {
            progress = 100;
            clearInterval(executionInterval);
            status.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Execution completed!';
        }
        
        progressBar.style.width = progress + '%';
        progressBar.textContent = Math.round(progress) + '%';
        status.innerHTML = `<i class="fas fa-cog fa-spin me-2"></i>Executing... ${Math.round(progress)}%`;
    }, 500);
}

// Refresh workflows
function refreshWorkflows() {
    loadWorkflows();
    showNotification('Workflows refreshed', 'success');
}

// Show workflow information
function showWorkflowInfo() {
    const info = `
üöÄ Phase 2: Interactive Workflow Visualization ‚úÖ

Features implemented:
‚Ä¢ Interactive workflow diagrams
‚Ä¢ Real-time stage monitoring
‚Ä¢ Workflow execution controls
‚Ä¢ Detailed stage information
‚Ä¢ Visual workflow designer
‚Ä¢ Execution progress tracking
‚Ä¢ WebSocket real-time updates

Controls available:
‚Ä¢ Play: Start workflow execution
‚Ä¢ Pause: Pause execution
‚Ä¢ Stop: Stop execution
‚Ä¢ Step: Execute next stage

Click on any workflow card to visualize it!
    `;
    alert(info);
}

// Get status badge HTML
function getStatusBadge(status) {
    if (status === 'completed') {
        return '<span class="badge bg-success">Completed</span>';
    } else if (status === 'failed') {
        return '<span class="badge bg-danger">Failed</span>';
    } else if (status === 'running') {
        return '<span class="badge bg-info">Running</span>';
    } else {
        return `<span class="badge bg-secondary">${status || 'Unknown'}</span>`;
    }
}

// WebSocket event handlers for Phase 2
function setupWebSocketHandlers() {
    if (typeof socket !== 'undefined' && socket) {
        console.log('üîå Setting up WebSocket handlers for workflow events');
        
        socket.on('workflow_stages', function(data) {
            console.log('üìä Received workflow stages:', data);
            displayWorkflowStages(data);
            document.getElementById('workflow-diagram-container').style.display = 'block';
        });
        
        socket.on('workflow_details', function(data) {
            console.log('üìã Received workflow details:', data);
            displayWorkflowDetails(data);
            document.getElementById('workflow-details-container').style.display = 'block';
        });
        
        socket.on('execution_update', function(data) {
            console.log('‚ö° Execution update:', data);
            showNotification(`Execution ${data.action}: ${data.message}`, 'info');
        });
        
        socket.on('workflow_progress', function(data) {
            console.log('üìà Workflow progress:', data);
            updateExecutionProgress(data);
        });
        
        socket.on('error', function(data) {
            console.error('‚ùå WebSocket error:', data);
            showNotification(`Error: ${data.message}`, 'danger');
        });
        
        socket.on('connect', function() {
            console.log('‚úÖ WebSocket connected for workflow page');
        });
        
        socket.on('disconnect', function() {
            console.log('‚ùå WebSocket disconnected from workflow page');
        });
        
        return true;
    } else {
        console.warn('‚ö†Ô∏è Socket not available, retrying in 1 second...');
        return false;
    }
}

// Initialize workflow page
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ Phase 2: Interactive Workflow Visualization initialized');
    
    // Try to set up WebSocket handlers
    let handlersSetup = false;
    let retryCount = 0;
    const maxRetries = 10;
    
    function trySetupHandlers() {
        if (setupWebSocketHandlers()) {
            handlersSetup = true;
            console.log('‚úÖ WebSocket handlers setup successful');
            loadWorkflows();
        } else if (retryCount < maxRetries) {
            retryCount++;
            console.log(`üîÑ Retry ${retryCount}/${maxRetries} for WebSocket setup`);
            setTimeout(trySetupHandlers, 1000);
        } else {
            console.error('‚ùå Failed to setup WebSocket handlers after maximum retries');
            // Fallback: load workflows anyway
            loadWorkflows();
        }
    }
    
    trySetupHandlers();
});

// Display workflow stages diagram
function displayWorkflowStages(data) {
    const container = document.getElementById('workflow-stages');
    workflowStages = data.stages;
    
    const stagesHtml = data.stages.map(stage => `
        <div class="workflow-stage ${stage.status}" data-stage="${stage.stage_id}">
            <div class="stage-header">
                <div class="stage-number">${stage.order}</div>
                <div class="stage-info">
                    <h6 class="stage-name">${stage.name}</h6>
                    <p class="stage-description">${stage.description}</p>
                </div>
                <div class="stage-status">
                    ${getStageStatusIcon(stage.status)}
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = `
        <div class="workflow-overview mb-3">
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="stat-card">
                        <h4 class="text-primary">${data.total_stages}</h4>
                        <small>Total Stages</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <h4 class="text-success">${data.completed_count}</h4>
                        <small>Completed</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <h4 class="text-danger">${data.failed_count}</h4>
                        <small>Failed</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <h4 class="text-info">${data.current_stage || 'None'}</h4>
                        <small>Current Stage</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="stages-container">
            ${stagesHtml}
        </div>
    `;
}

// Display workflow details
function displayWorkflowDetails(data) {
    const container = document.getElementById('workflow-details');
    
    // Format the stage data for better display
    let stageDataDisplay = 'No stage data available';
    if (data.stage_data) {
        try {
            const parsed = JSON.parse(data.stage_data);
            stageDataDisplay = JSON.stringify(parsed, null, 2);
        } catch {
            stageDataDisplay = data.stage_data;
        }
    }
    
    // Format stage info for display
    let stageInfoDisplay = '';
    if (data.stage_info && data.stage_info.summary) {
        stageInfoDisplay = `
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle me-2"></i>Workflow Summary</h6>
                <p class="mb-2">${data.stage_info.summary}</p>
                <div class="row">
                    <div class="col-md-3">
                        <strong>Total Stages:</strong> ${data.stage_info.total_stages}
                    </div>
                    <div class="col-md-3">
                        <strong>Completion:</strong> ${data.stage_info.completion_timestamp}
                    </div>
                    <div class="col-md-3">
                        <strong>Success Rate:</strong> ${data.success_rate}
                    </div>
                    <div class="col-md-3">
                        <strong>Status:</strong> ${getStatusBadge(data.status)}
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = `
        ${stageInfoDisplay}
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-cogs me-2"></i>Workflow Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>ID:</strong></td><td><code>${data.id}</code></td></tr>
                    <tr><td><strong>Status:</strong></td><td>${getStatusBadge(data.status)}</td></tr>
                    <tr><td><strong>Current Stage:</strong></td><td>${data.current_stage || 'None'}</td></tr>
                    <tr><td><strong>Completed Stages:</strong></td><td>${data.total_completed}</td></tr>
                    <tr><td><strong>Failed Stages:</strong></td><td>${data.total_failed}</td></tr>
                    <tr><td><strong>Success Rate:</strong></td><td>${data.success_rate}</td></tr>
                    <tr><td><strong>Created:</strong></td><td>${data.created_at || 'Unknown'}</td></tr>
                    <tr><td><strong>Updated:</strong></td><td>${data.updated_at || 'Unknown'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-database me-2"></i>Stage Data</h6>
                <div class="stage-data-container">
                    <pre class="bg-light p-2 rounded"><code>${stageDataDisplay}</code></pre>
                </div>
            </div>
        </div>
    `;
}

// Get stage status icon
function getStageStatusIcon(status) {
    switch (status) {
        case 'completed':
            return '<i class="fas fa-check-circle text-success fa-lg"></i>';
        case 'running':
            return '<i class="fas fa-play-circle text-info fa-lg"></i>';
        case 'failed':
            return '<i class="fas fa-times-circle text-danger fa-lg"></i>';
        default:
            return '<i class="fas fa-clock text-muted fa-lg"></i>';
    }
}

// Update execution progress
function updateExecutionProgress(data) {
    const progressBar = document.getElementById('execution-progress-bar');
    const status = document.getElementById('execution-status');
    
    if (data.progress) {
        progressBar.style.width = data.progress + '%';
        progressBar.textContent = Math.round(data.progress) + '%';
    }
    
    if (data.message) {
        status.innerHTML = `<i class="fas fa-cog fa-spin me-2"></i>${data.message}`;
    }
}
</script>
{% endblock %}
