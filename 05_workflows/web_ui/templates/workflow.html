{% extends "base.html" %}

{% block title %}Workflows - Workflow Visualization{% endblock %}

{% block content %}
<div class="row">
    <!-- Page Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-project-diagram me-2"></i>Interactive Workflow Visualization</h1>
            <div>
                <button class="btn btn-outline-primary me-2" onclick="refreshWorkflows()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button class="btn btn-primary" onclick="showWorkflowInfo()">
                    <i class="fas fa-info-circle me-1"></i>Info
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Workflow List -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-list me-1"></i>Available Workflows
                </h6>
            </div>
            <div class="card-body">
                <div id="workflows-container">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>
                        <p>Loading workflows...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Interactive Workflow Diagram -->
<div class="row mt-4" id="workflow-diagram-container" style="display: none;">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-sitemap me-1"></i>BPMN Workflow Execution Diagram
                </h6>
                <div>
                    <button class="btn btn-sm btn-success me-2" onclick="executeWorkflow('play')">
                        <i class="fas fa-play me-1"></i>Play
                    </button>
                    <button class="btn btn-sm btn-warning me-2" onclick="executeWorkflow('pause')">
                        <i class="fas fa-pause me-1"></i>Pause
                    </button>
                    <button class="btn btn-sm btn-danger me-2" onclick="executeWorkflow('stop')">
                        <i class="fas fa-stop me-1"></i>Stop
                    </button>
                    <button class="btn btn-sm btn-info" onclick="executeWorkflow('step')">
                        <i class="fas fa-forward me-1"></i>Step
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- BPMN Workflow Canvas -->
                <div id="bpmn-workflow-canvas" class="bpmn-canvas">
                    <!-- Workflow blocks will be dynamically generated here -->
                </div>
                
                <!-- Workflow Data Flow Panel -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="m-0"><i class="fas fa-database me-1"></i>Data Flow Inspector</h6>
                            </div>
                            <div class="card-body">
                                <div id="data-flow-info">
                                    <p class="text-muted">Click on any workflow block to inspect its data flow</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="m-0"><i class="fas fa-chart-line me-1"></i>Execution Timeline</h6>
                            </div>
                            <div class="card-body">
                                <div id="execution-timeline">
                                    <p class="text-muted">Execution timeline will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Workflow Details Panel -->
<div class="row mt-4" id="workflow-details-container" style="display: none;">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-info-circle me-1"></i>Workflow Details
                </h6>
            </div>
            <div class="card-body">
                <div id="workflow-details">
                    <!-- Workflow details will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Execution Progress -->
<div class="row mt-4" id="execution-progress-container" style="display: none;">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-tasks me-1"></i>Execution Progress
                </h6>
            </div>
            <div class="card-body">
                <div class="progress mb-3" style="height: 25px;">
                    <div id="execution-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%">0%</div>
                </div>
                <div id="execution-status" class="text-muted">
                    Ready to execute...
                </div>
            </div>
        </div>
    </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Global variables for Phase 2
let currentWorkflowId = null;
let workflowStages = [];
let executionInterval = null;

// Load available workflows
function loadWorkflows() {
    fetch('/api/workflows')
        .then(response => response.json())
        .then(data => {
            displayWorkflows(data.workflows);
        })
        .catch(error => {
            console.error('Error loading workflows:', error);
            showNotification('Failed to load workflows', 'danger');
        });
}

// Display workflows in the container
function displayWorkflows(workflows) {
    const container = document.getElementById('workflows-container');
    
    if (!workflows || workflows.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-3x text-gray-300 mb-3"></i>
                <h5 class="text-gray-500">No Workflows Found</h5>
                <p class="text-gray-400">No workflow data is currently available.</p>
                <button class="btn btn-primary" onclick="loadWorkflows()">
                    <i class="fas fa-sync-alt me-1"></i>Check Again
                </button>
            </div>
        `;
        return;
    }
    
    const workflowsHtml = workflows.map(workflow => `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100 workflow-card" onclick="selectWorkflow('${workflow.id}')">
                <div class="card-body text-center">
                    <div class="workflow-icon mb-3">
                        <i class="fas fa-project-diagram fa-3x text-primary"></i>
                    </div>
                    <h6 class="card-title">${workflow.type}</h6>
                    <p class="card-text small">ID: ${workflow.id.substring(0, 8)}...</p>
                    <div class="workflow-status mb-2">
                        ${getStatusBadge(workflow.status)}
                    </div>
                    <div class="workflow-stage small text-muted">
                        Stage: ${workflow.stage || 'Unknown'}
                    </div>
                    <div class="workflow-actions mt-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewWorkflowDetails('${workflow.id}')">
                            <i class="fas fa-eye me-1"></i>View
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); loadWorkflowStages('${workflow.id}')">
                            <i class="fas fa-sitemap me-1"></i>Diagram
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = `
        <div class="row">
            ${workflowsHtml}
        </div>
    `;
}

// Select a workflow for visualization
function selectWorkflow(workflowId) {
    currentWorkflowId = workflowId;
    loadWorkflowStages(workflowId);
    showNotification(`Selected workflow: ${workflowId.substring(0, 8)}...`, 'info');
}

// Load workflow stages for visualization
function loadWorkflowStages(workflowId) {
    console.log('üîó Diagram button clicked for workflow:', workflowId);
    
    if (!socket) {
        console.error('‚ùå Socket not available for loadWorkflowStages');
        showNotification('WebSocket not connected', 'warning');
        return;
    }
    
    if (!socket.connected) {
        console.error('‚ùå Socket not connected for loadWorkflowStages');
        showNotification('WebSocket connection lost', 'warning');
        return;
    }
    
    console.log('üì° Emitting get_workflow_stages event for workflow:', workflowId);
    socket.emit('get_workflow_stages', { workflow_id: workflowId });
}

// View workflow details
function viewWorkflowDetails(workflowId) {
    console.log('üëÅÔ∏è View button clicked for workflow:', workflowId);
    
    if (!socket) {
        console.error('‚ùå Socket not available for viewWorkflowDetails');
        showNotification('WebSocket not connected', 'warning');
        return;
    }
    
    if (!socket.connected) {
        console.error('‚ùå Socket not connected for viewWorkflowDetails');
        showNotification('WebSocket connection lost', 'warning');
        return;
    }
    
    console.log('üì° Emitting get_workflow_details event for workflow:', workflowId);
    socket.emit('get_workflow_details', { workflow_id: workflowId });
}

// Execute workflow commands
function executeWorkflow(action) {
    if (!currentWorkflowId) {
        showNotification('Please select a workflow first', 'warning');
        return;
    }
    
    if (!socket) {
        showNotification('WebSocket not connected', 'warning');
        return;
    }
    
    socket.emit('execute_workflow', { 
        workflow_id: currentWorkflowId, 
        action: action 
    });
    
    showNotification(`Workflow ${action} command sent`, 'info');
    
    // Show execution progress
    document.getElementById('execution-progress-container').style.display = 'block';
    
    // Simulate progress for demo
    if (action === 'play') {
        simulateExecutionProgress();
    }
}

// Simulate execution progress
function simulateExecutionProgress() {
    const progressBar = document.getElementById('execution-progress-bar');
    const status = document.getElementById('execution-status');
    let progress = 0;
    
    if (executionInterval) {
        clearInterval(executionInterval);
    }
    
    executionInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress >= 100) {
            progress = 100;
            clearInterval(executionInterval);
            status.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Execution completed!';
        }
        
        progressBar.style.width = progress + '%';
        progressBar.textContent = Math.round(progress) + '%';
        status.innerHTML = `<i class="fas fa-cog fa-spin me-2"></i>Executing... ${Math.round(progress)}%`;
    }, 500);
}

// Refresh workflows
function refreshWorkflows() {
    loadWorkflows();
    showNotification('Workflows refreshed', 'success');
}

// Show workflow information
function showWorkflowInfo() {
    const info = `
üöÄ Phase 2: Interactive Workflow Visualization ‚úÖ

Features implemented:
‚Ä¢ Interactive workflow diagrams
‚Ä¢ Real-time stage monitoring
‚Ä¢ Workflow execution controls
‚Ä¢ Detailed stage information
‚Ä¢ Visual workflow designer
‚Ä¢ Execution progress tracking
‚Ä¢ WebSocket real-time updates

Controls available:
‚Ä¢ Play: Start workflow execution
‚Ä¢ Pause: Pause execution
‚Ä¢ Stop: Stop execution
‚Ä¢ Step: Execute next stage

Click on any workflow card to visualize it!
    `;
    alert(info);
}

// Get status badge HTML
function getStatusBadge(status) {
    if (status === 'completed') {
        return '<span class="badge bg-success">Completed</span>';
    } else if (status === 'failed') {
        return '<span class="badge bg-danger">Failed</span>';
    } else if (status === 'running') {
        return '<span class="badge bg-info">Running</span>';
    } else {
        return `<span class="badge bg-secondary">${status || 'Unknown'}</span>`;
    }
}

// WebSocket event handlers for Phase 2
function setupWebSocketHandlers() {
    if (typeof socket !== 'undefined' && socket) {
        console.log('üîå Setting up WebSocket handlers for workflow events');
        
        socket.on('workflow_stages', function(data) {
            console.log('üìä Received workflow stages:', data);
            displayWorkflowStages(data);
            document.getElementById('workflow-diagram-container').style.display = 'block';
        });
        
        socket.on('workflow_details', function(data) {
            console.log('üìã Received workflow details:', data);
            displayWorkflowDetails(data);
            document.getElementById('workflow-details-container').style.display = 'block';
        });
        
        socket.on('execution_update', function(data) {
            console.log('‚ö° Execution update:', data);
            showNotification(`Execution ${data.action}: ${data.message}`, 'info');
        });
        
        socket.on('workflow_progress', function(data) {
            console.log('üìà Workflow progress:', data);
            updateExecutionProgress(data);
        });
        
        socket.on('error', function(data) {
            console.error('‚ùå WebSocket error:', data);
            showNotification(`Error: ${data.message}`, 'danger');
        });
        
        socket.on('connect', function() {
            console.log('‚úÖ WebSocket connected for workflow page');
        });
        
        socket.on('disconnect', function() {
            console.log('‚ùå WebSocket disconnected from workflow page');
        });
        
        return true;
    } else {
        console.warn('‚ö†Ô∏è Socket not available, retrying in 1 second...');
        return false;
    }
}

// Initialize workflow page
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ Phase 2: Interactive Workflow Visualization initialized');
    
    // Try to set up WebSocket handlers
    let handlersSetup = false;
    let retryCount = 0;
    const maxRetries = 10;
    
    function trySetupHandlers() {
        if (setupWebSocketHandlers()) {
            handlersSetup = true;
            console.log('‚úÖ WebSocket handlers setup successful');
            loadWorkflows();
        } else if (retryCount < maxRetries) {
            retryCount++;
            console.log(`üîÑ Retry ${retryCount}/${maxRetries} for WebSocket setup`);
            setTimeout(trySetupHandlers, 1000);
        } else {
            console.error('‚ùå Failed to setup WebSocket handlers after maximum retries');
            // Fallback: load workflows anyway
            loadWorkflows();
        }
    }
    
    trySetupHandlers();
});

// Display workflow stages diagram
function displayWorkflowStages(data) {
    const container = document.getElementById('bpmn-workflow-canvas');
    workflowStages = data.stages;
    
    // Clear existing content
    container.innerHTML = '';
    
    // Add SVG definitions for arrow markers
    const svgDefs = `
        <svg width="0" height="0" style="position: absolute;">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                        refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#0d6efd" />
                </marker>
            </defs>
        </svg>
    `;
    container.insertAdjacentHTML('beforeend', svgDefs);
    
    // Create workflow blocks
    const workflowBlocks = data.stages.map(stage => {
        const block = document.createElement('div');
        block.className = `workflow-block ${stage.stage_id} ${stage.status}`;
        block.setAttribute('data-stage', stage.stage_id);
        block.onclick = () => selectWorkflowBlock(stage, data);
        
        block.innerHTML = `
            <div class="workflow-block-icon">
                ${getStageIcon(stage.stage_id)}
            </div>
            <div class="workflow-block-title">${stage.name}</div>
            <div class="workflow-block-status">${stage.status}</div>
        `;
        
        return block;
    });
    
    // Add blocks to canvas
    workflowBlocks.forEach(block => container.appendChild(block));
    
    // Create data flow arrows
    createDataFlowArrows(container, data.stages);
    
    // Update execution timeline
    updateExecutionTimeline(data);
    
    // Update workflow overview
    updateWorkflowOverview(data);
}

// Create data flow arrows between workflow blocks
function createDataFlowArrows(container, stages) {
    for (let i = 0; i < stages.length - 1; i++) {
        const currentStage = stages[i];
        const nextStage = stages[i + 1];
        
        const arrow = createDataFlowArrow(
            currentStage.stage_id,
            nextStage.stage_id,
            getDataFlowLabel(currentStage, nextStage)
        );
        
        container.appendChild(arrow);
    }
}

// Create a data flow arrow SVG
function createDataFlowArrow(fromStage, toStage, label) {
    const arrow = document.createElement('div');
    arrow.className = 'data-flow-arrow';
    
    // Calculate arrow position based on stage positions
    const positions = {
        'planning': { x: 150, y: 110 },
        'data-processing': { x: 400, y: 110 },
        'business-logic': { x: 650, y: 110 },
        'approval': { x: 900, y: 110 },
        'finalization': { x: 1150, y: 110 }
    };
    
    const fromPos = positions[fromStage];
    const toPos = positions[toStage];
    
    if (fromPos && toPos) {
        const arrowSvg = `
            <svg width="${toPos.x - fromPos.x + 50}" height="60" 
                 style="position: absolute; left: ${fromPos.x}px; top: ${fromPos.y}px;">
                <path class="arrow-path" 
                      d="M 0 30 Q ${(toPos.x - fromPos.x) / 2} 0 ${toPos.x - fromPos.x} 30" 
                      marker-end="url(#arrowhead)" />
                <text class="data-flow-label" x="${(toPos.x - fromPos.x) / 2}" y="20">${label}</text>
            </svg>
        `;
        arrow.innerHTML = arrowSvg;
    }
    
    return arrow;
}

// Get data flow label between stages
function getDataFlowLabel(fromStage, toStage) {
    const flowLabels = {
        'planning-data-processing': 'Requirements ‚Üí Data',
        'data-processing-business-logic': 'Raw Data ‚Üí Processed',
        'business-logic-approval': 'Validated ‚Üí Pending',
        'approval-finalization': 'Approved ‚Üí Complete'
    };
    
    const key = `${fromStage.stage_id}-${toStage.stage_id}`;
    return flowLabels[key] || 'Data Flow';
}

// Get stage icon
function getStageIcon(stageId) {
    const icons = {
        'planning': 'fas fa-lightbulb',
        'data-processing': 'fas fa-database',
        'business-logic': 'fas fa-cogs',
        'approval': 'fas fa-user-check',
        'finalization': 'fas fa-flag-checkered'
    };
    
    return `<i class="${icons[stageId] || 'fas fa-cube'}"></i>`;
}

// Select workflow block for data inspection
function selectWorkflowBlock(stage, workflowData) {
    // Remove previous selection
    document.querySelectorAll('.workflow-block').forEach(block => {
        block.classList.remove('selected');
    });
    
    // Select current block
    const selectedBlock = document.querySelector(`.workflow-block.${stage.stage_id}`);
    if (selectedBlock) {
        selectedBlock.classList.add('selected');
    }
    
    // Update data flow inspector
    updateDataFlowInspector(stage, workflowData);
}

// Update data flow inspector panel
function updateDataFlowInspector(stage, workflowData) {
    const container = document.getElementById('data-flow-info');
    
    // Get stage-specific data
    const stageData = getStageData(stage, workflowData);
    
    container.innerHTML = `
        <div class="data-flow-panel">
            <h6 class="mb-3">${stage.name} - Data Flow</h6>
            
            <div class="data-flow-input">
                <div class="data-flow-header">
                    <i class="fas fa-sign-in-alt text-success"></i>
                    Input Data
                </div>
                <div class="data-flow-content">
                    ${formatStageData(stageData.input)}
                </div>
            </div>
            
            <div class="data-flow-output">
                <div class="data-flow-header">
                    <i class="fas fa-sign-out-alt text-primary"></i>
                    Output Data
                </div>
                <div class="data-flow-content">
                    ${formatStageData(stageData.output)}
                </div>
            </div>
            
            <div class="mt-3">
                <strong>Status:</strong> ${getStatusBadge(stage.status)}
                <br>
                <strong>Duration:</strong> ${stageData.duration || 'N/A'}
                <br>
                <strong>Data Size:</strong> ${stageData.dataSize || 'N/A'}
            </div>
        </div>
    `;
}

// Get stage-specific data for inspection
function getStageData(stage, workflowData) {
    // This would come from your actual workflow execution data
    // For now, we'll simulate realistic data based on stage type
    const stageDataMap = {
        'planning': {
            input: 'Workflow requirements, timeline, resource allocation',
            output: 'Project plan, timeline, resource schedule',
            duration: '2-5 minutes',
            dataSize: '5-10 KB'
        },
        'data-processing': {
            input: 'Raw data files, validation rules, quality parameters',
            output: 'Cleaned data, validation results, quality metrics',
            duration: '3-8 minutes',
            dataSize: '50-200 KB'
        },
        'business-logic': {
            input: 'Processed data, business rules, compliance requirements',
            output: 'Validated data, business logic results, compliance status',
            duration: '2-6 minutes',
            dataSize: '25-100 KB'
        },
        'approval': {
            input: 'Validated results, approval workflow, decision criteria',
            output: 'Approval status, decision history, next steps',
            duration: '1-3 minutes',
            dataSize: '10-30 KB'
        },
        'finalization': {
            input: 'Approved results, completion criteria, final checks',
            output: 'Final report, performance metrics, completion summary',
            duration: '1-2 minutes',
            dataSize: '15-50 KB'
        }
    };
    
    return stageDataMap[stage.stage_id] || {
        input: 'No input data available',
        output: 'No output data available',
        duration: 'N/A',
        dataSize: 'N/A'
    };
}

// Format stage data for display
function formatStageData(data) {
    if (typeof data === 'string') {
        return data;
    }
    
    try {
        return JSON.stringify(data, null, 2);
    } catch {
        return String(data);
    }
}

// Update execution timeline
function updateExecutionTimeline(workflowData) {
    const container = document.getElementById('execution-timeline');
    
    const timelineItems = workflowData.stages.map(stage => {
        const statusClass = stage.status;
        const icon = getTimelineIcon(stage.status);
        
        return `
            <div class="timeline-item ${statusClass}">
                <div class="timeline-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="timeline-content">
                    <div class="timeline-stage">${stage.name}</div>
                    <div class="timeline-details">${stage.description}</div>
                </div>
                <div class="timeline-time">${getCurrentTime()}</div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div class="execution-timeline">
            ${timelineItems}
        </div>
    `;
}

// Get timeline icon based on status
function getTimelineIcon(status) {
    const icons = {
        'completed': 'fas fa-check',
        'running': 'fas fa-play',
        'failed': 'fas fa-times',
        'pending': 'fas fa-clock'
    };
    
    return icons[status] || 'fas fa-question';
}

// Get current time for timeline
function getCurrentTime() {
    return new Date().toLocaleTimeString();
}

// Update workflow overview
function updateWorkflowOverview(workflowData) {
    // This function can be used to update any additional overview information
    console.log('Workflow overview updated:', workflowData);
}

// Display workflow details
function displayWorkflowDetails(data) {
    const container = document.getElementById('workflow-details');
    
    // Format the stage data for better display
    let stageDataDisplay = 'No stage data available';
    if (data.stage_data) {
        try {
            const parsed = JSON.parse(data.stage_data);
            stageDataDisplay = JSON.stringify(parsed, null, 2);
        } catch {
            stageDataDisplay = data.stage_data;
        }
    }
    
    // Format stage info for display
    let stageInfoDisplay = '';
    if (data.stage_info && data.stage_info.summary) {
        stageInfoDisplay = `
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle me-2"></i>Workflow Summary</h6>
                <p class="mb-2">${data.stage_info.summary}</p>
                <div class="row">
                    <div class="col-md-3">
                        <strong>Total Stages:</strong> ${data.stage_info.total_stages}
                    </div>
                    <div class="col-md-3">
                        <strong>Completion:</strong> ${data.stage_info.completion_timestamp}
                    </div>
                    <div class="col-md-3">
                        <strong>Success Rate:</strong> ${data.success_rate}
                    </div>
                    <div class="col-md-3">
                        <strong>Status:</strong> ${getStatusBadge(data.status)}
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = `
        ${stageInfoDisplay}
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-cogs me-2"></i>Workflow Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>ID:</strong></td><td><code>${data.id}</code></td></tr>
                    <tr><td><strong>Status:</strong></td><td>${getStatusBadge(data.status)}</td></tr>
                    <tr><td><strong>Current Stage:</strong></td><td>${data.current_stage || 'None'}</td></tr>
                    <tr><td><strong>Completed Stages:</strong></td><td>${data.total_completed}</td></tr>
                    <tr><td><strong>Failed Stages:</strong></td><td>${data.total_failed}</td></tr>
                    <tr><td><strong>Success Rate:</strong></td><td>${data.success_rate}</td></tr>
                    <tr><td><strong>Created:</strong></td><td>${data.created_at || 'Unknown'}</td></tr>
                    <tr><td><strong>Updated:</strong></td><td>${data.updated_at || 'Unknown'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-database me-2"></i>Stage Data</h6>
                <div class="stage-data-container">
                    <pre class="bg-light p-2 rounded"><code>${stageDataDisplay}</code></pre>
                </div>
            </div>
        </div>
    `;
}

// Update execution progress
function updateExecutionProgress(data) {
    const progressBar = document.getElementById('execution-progress-bar');
    const status = document.getElementById('execution-status');
    
    if (data.progress) {
        progressBar.style.width = data.progress + '%';
        progressBar.textContent = Math.round(data.progress) + '%';
    }
    
    if (data.message) {
        status.innerHTML = `<i class="fas fa-cog fa-spin me-2"></i>${data.message}`;
    }
}
</script>
{% endblock %}
